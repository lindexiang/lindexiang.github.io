---
title: JVM-8
images: /images/摘要配图/
date: 2018-08-14 00:38:34
tags:
---



# 第8章 虚拟机字节码执行引擎

> JAVA虚拟机规范中规定了虚拟机字节码执行引擎的概念模型。从概念模型的角度讲解虚拟机的方法调用和字节码执行。
> 
> 


## 运行时栈帧结构
栈帧时用于支持虚拟机进行方法调用和方法执行的数据结构，是虚拟机运行时的数据区**虚拟机栈**的栈元素。**栈帧中保存了方法调用的局部变量表，操作数栈，动态链接和方法返回地址等信息。**每一个方法的开始执行到执行完毕对应着栈帧在虚拟机栈中的入栈和出栈操作。
一个线程中的方法调用链可能很长，在活动线程中，只有栈顶的栈帧才是有效的。
![](http://pbhb4py13.bkt.clouddn.com/15332259001761.jpg)

### 局部变量表
局部变量表是一组变量值存储空间，主要来保存方法参数和方法内定义的局部变量。在java代码编译时确定了该方法所需分配的局部变量表的最大容量。局部变量的存储单位是slot，一个Slot可以存放一个32位以内（boolean、byte、char、short、int、float、reference和returnAddress）的数据类型，reference类型表示一个对象实例的引用，returnAddress已经很少见了，可以忽略。对于64位的数据类型，long和double采用高位对齐的方式分配连续的两个slot。
> 对于reference类型表示对一个对象实例的引用，该引用有2个用处。
> 1. 使用该引用找到java堆中该对象的存储的地址索引。
> 2. 使用该引用可以找到该对象所属类的数据类型在方法区中存储的类型信息，其实就是该类的class对象的信息，class对象比较特殊，存储在方法区中。

java虚拟机通过索引定位的方式来使用局部变量表，索引范围是从0到最大值。0代表的是this指针。索引n代表使用了第n个slot，64位的数据是连续使用n和n+1的slot。slot可以被复用，为了节省空间。

### 操作数栈
操作数栈是一个后进先出的数据结构，当方法执行时，方法中的操作数对应着**入栈和出栈的操作**。即会各种指令向操作数栈中写入和提取内容。
![](http://pbhb4py13.bkt.clouddn.com/15332284712969.jpg)

在概念模型中，一个活动线程的两个栈帧是相互独立的，但是虚拟机会做优化处理，让下一个栈帧的部分操作数栈和上一个栈帧的局部变量表重叠，可以共享一部分数据，无需额外的数据赋值传递。
### 动态链接

每个栈帧都包含一个指向运行时常量池中该栈帧所属方法的引用。持有引用为了支持方法调用过程的动态链接。class文件中的常量池中存在大量的符号引用，**字节码的方法调用指令是以指向常量池中的符号引用作为参数的**。则可以通过字节码迅速定位到具体的方法代码。**一部分符号引用在类加载或者第一次使用时转化成直接引用，这种转化称为静态解析。另一部分在每次运行时才转为直接引用，称为动态链接**。

### 方法返回地址








